{% extends 'base.html' %}
{% block content %}
{% include 'navbar.html' %}

<div class="pt-20 min-h-screen bg-gradient-to-b from-emerald-400 via-teal-400 to-blue-600">
  <div class="max-w-2xl mx-auto px-4 pb-24">

    <!-- Filter wrapper in a single box/card -->
    <div class="mb-6">
      <div class="rounded-xl border border-gray-200 bg-white/90 shadow-sm">
        <div class="px-3 py-2">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">

            <!-- Tabs (All / My) -->
            <div class="inline-flex rounded-full bg-gray-100 px-1 py-1 font-semibold">
              <a href="?filter=all{% if active_category and active_category != 'all' %}&category={{ active_category }}{% endif %}"
                class="px-4 py-2 rounded-full transition {% if active_filter == 'all' %}bg-white text-emerald-700 shadow{% else %}text-gray-700 hover:bg-white/80{% endif %}">
                All Feeds
              </a>
              <a href="?filter=my{% if active_category and active_category != 'all' %}&category={{ active_category }}{% endif %}"
                class="px-4 py-2 rounded-full transition {% if active_filter == 'my' %}bg-white text-emerald-700 shadow{% else %}text-gray-700 hover:bg-white/80{% endif %}">
                My Feeds
              </a>
            </div>

            <!-- Sport Type filter -->
            <form method="get" class="flex items-center gap-2 text-sm">
              <input type="hidden" name="filter" value="{{ active_filter|default:'all' }}">
              <label for="category" class="text-gray-700 font-medium">Sport Type</label>

              <select id="category" name="category" class="border border-gray-300 rounded-md px-3 py-1.5 bg-white focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" onchange="this.form.submit()">
                <option value="all" {% if active_category == 'all' %}selected{% endif %}>All</option>
                <option value="soccer" {% if active_category == 'soccer' %}selected{% endif %}>Soccer</option>
                <option value="futsal" {% if active_category == 'futsal' %}selected{% endif %}>Futsal</option>
                <option value="basket" {% if active_category == 'basket' %}selected{% endif %}>Basket</option>
                <option value="badminton" {% if active_category == 'badminton' %}selected{% endif %}>Badminton</option>
                <option value="other" {% if active_category == 'other' %}selected{% endif %}>Other</option>
              </select>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- Empty -->
    {% if not post_list %}
      <div class="bg-white/95 rounded-xl border border-white/50 shadow p-12 text-center">
        <p class="text-gray-600">Belum ada feed.</p>
      </div>
    {% else %}
      <div class="space-y-4">
        {% for p in post_list %}
          <article class="relative bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition">
            <!-- seluruh isi post -->
            <a href="{% url 'feeds:show_post' p.id %}" class="block p-4 z-0">
              <div class="text-base font-semibold text-gray-900">
                {% if p.user %}@{{ p.user.username }}{% else %}Anon{% endif %}
              </div>
              <p class="text-sm text-gray-600 mt-1">
                <b>{{ p.get_category_display }}</b>
                {% if p.is_featured %} | <b>Featured</b>{% endif %}
                {% if p.is_post_hot %} | <b>Hot</b>{% endif %}
                | <i>{{ p.created_at|date:"d M Y H:i" }}</i>
                | Views: {{ p.post_views }}
              </p>
              {% if p.thumbnail %}
                <img class="mt-3 rounded-lg max-h-52 w-full object-cover" src="{{ p.thumbnail }}" alt="thumbnail">
              {% endif %}
              <p class="mt-3 text-gray-800 line-clamp-4">{{ p.content }}</p>
            </a>

            {% if user.is_authenticated and p.user == user %}
              <!-- tombol titik 3 -->
              <button
                type="button"
                class="absolute top-3 right-3 p-2 rounded-full hover:bg-gray-100 focus:outline-none z-10 pointer-events-auto"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="menu-{{ p.id }}"
                onclick="event.stopPropagation(); toggleMenu('{{ p.id }}')"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
              </button>

              <!-- dropdown -->
              <div
                id="menu-{{ p.id }}"
                class="hidden absolute right-3 top-10 z-20 w-36 rounded-lg border border-gray-200 bg-white shadow-lg overflow-hidden"
                role="menu"
                onclick="event.stopPropagation()"
              >
                <a href="{% url 'feeds:edit_post' p.id %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50" role="menuitem">
                  Edit
                </a>
                <button
                  type="button"
                  onclick="openModal('{{ p.id }}'); event.stopPropagation();"
                  class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50"
                  role="menuitem">
                  Delete
                </button>
              </div>

              <!-- modal konfirmasi delete -->
              <div id="modal-{{ p.id }}" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-lg w-80" onclick="event.stopPropagation()">
                  <h2 class="text-lg font-semibold mb-4 text-gray-800">Delete Post</h2>
                  <p class="text-gray-700 mb-6">Are you sure you want to delete this post?</p>
                  <div class="flex justify-end gap-2">
                    <button onclick="closeModal('{{ p.id }}')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancel</button>
                    <form method="POST" action="{% url 'feeds:delete_post' p.id %}">
                      {% csrf_token %}
                      <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- Floating + button -->
  <a href="{% url 'feeds:create_post' %}" class="fixed right-6 bottom-6 w-14 h-14 rounded-full bg-emerald-600 hover:bg-emerald-700 text-white flex items-center justify-center text-3xl shadow-xl z-50">+</a>
</div>

<script>
  function toggleMenu(id) {
    const el = document.getElementById(`menu-${id}`);
    el.classList.toggle('hidden');
  }
  function openModal(id) {
    document.getElementById(`modal-${id}`).classList.remove('hidden');
    document.getElementById(`menu-${id}`)?.classList.add('hidden');
  }
  function closeModal(id) {
    document.getElementById(`modal-${id}`).classList.add('hidden');
  }
  // tutup menu/modal saat klik di luar
  document.addEventListener('click', () => {
    document.querySelectorAll('[id^="menu-"]').forEach(m => m.classList.add('hidden'));
    document.querySelectorAll('[id^="modal-"]').forEach(m => m.classList.add('hidden'));
  });
</script>
{% endblock content %}
