{% extends 'base.html' %}
{% block content %}
{% include 'navbar.html' %}
{% include 'toast.html' %}


<div class="pt-20 min-h-screen bg-white">
  <div class="max-w-2xl mx-auto px-4 pb-24">

    <!-- Bar filter -->
    <div class="bg-white/40 backdrop-blur rounded-2xl px-4 py-3 border border-white/60 shadow-sm mb-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <!-- Tabs (All/My) -->
        <div class="inline-flex rounded-full bg-white/30 backdrop-blur px-1 py-1 text-emerald-900 font-semibold overflow-x-auto max-w-full sm:max-w-none">
          <button id="btn-all" class="px-5 py-2 rounded-full font-semibold transition shadow-none">All Feeds</button>
          <button id="btn-my"  class="px-5 py-2 rounded-full font-semibold transition shadow-none">My Feeds</button>
        </div>

        <!-- Sport Type filter -->
        <div class="flex items-center gap-2 text-sm sm:justify-end">
        <label class="text-gray-700 shrink-0">Sport Type</label>
        <select id="select-category" class="w-full sm:w-auto px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="all">All</option>
            <option value="soccer">Soccer</option>
            <option value="futsal">Futsal</option>
            <option value="basket">Basket</option>
            <option value="badminton">Badminton</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div id="feeds-loading" class="bg-white/95 rounded-xl border border-white/60 shadow p-12 text-center hidden">
      <div class="animate-spin inline-block rounded-full h-8 w-8 border-2 border-emerald-600 border-t-transparent"></div>
      <p class="text-gray-600 mt-3">Loading feeds...</p>
    </div>

    <!-- Error -->
    <div id="feeds-error" class="bg-white/95 rounded-xl border border-red-300 shadow p-6 text-center hidden">
      <p class="text-red-600 font-medium">Failed to load feeds. Try again.</p>
    </div>

    <!-- Empty -->
    <div id="feeds-empty"
        class="hidden bg-gradient-to-b from-white/90 to-white/70 rounded-2xl border border-white/60 shadow p-10 text-center">
      <!-- Illust -->
      <div class="mx-auto w-40 h-40 mb-6 relative">
        <!-- lingkaran blur -->
        <div class="absolute inset-0 rounded-full bg-emerald-300/20 blur-2xl"></div>
        <!-- bola (inline SVG) -->
        <svg viewBox="0 0 128 128" class="relative w-full h-full drop-shadow-sm">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0" stop-color="#34d399"/>
              <stop offset="1" stop-color="#10b981"/>
            </linearGradient>
          </defs>
          <circle cx="64" cy="64" r="48" fill="url(#g)" opacity="0.25"></circle>
          <circle cx="64" cy="64" r="42" fill="none" stroke="#34d399" stroke-width="4"></circle>
          <path d="M22 64h84M64 22v84M32 40c28 0 28 48 64 48M32 88c28 0 28-48 64-48"
                stroke="#10b981" stroke-width="4" fill="none" stroke-linecap="round" />
        </svg>
      </div>

      <h3 class="text-2xl sm:text-3xl font-extrabold text-emerald-900">Belum Ada Feeds</h3>
      <p class="mt-2 text-emerald-900/70">
        Jadilah yang pertama berbagi momen olahraga di LapaNG!
      </p>

      <div class="mt-6">
        {% if user.is_authenticated %}
          <button id="btn-empty-create"
                  class="inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-emerald-600 text-white
                        hover:bg-emerald-700 shadow-lg shadow-emerald-600/20 transition">
            <span class="text-xl leading-none">＋</span> Buat Post Baru
          </button>
        {% else %}
          <a href="{% url 'login' %}"
            class="inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-emerald-600 text-white
                    hover:bg-emerald-700 shadow-lg shadow-emerald-600/20 transition">
            Login untuk membuat post
          </a>
        {% endif %}
      </div>
    </div>


    <!-- List -->
    <div id="feeds-list" class="space-y-4 hidden"></div>
  </div>

  <!-- Floating + button -->
  <button id="btn-open-create" class="fixed bottom-6 right-6 md:right-[calc((100vw-42rem)/2-2.75rem)] lg:right-[calc((100vw-42rem)/2-3.5rem)] xl:right-[calc((100vw-42rem)/2-4rem)] w-14 h-14 rounded-full bg-emerald-600 hover:bg-emerald-700 text-white flex items-center justify-center text-3xl shadow-xl z-50">
    +
  </button>

</div>

<!-- Modal Create Post -->
<div id="create-modal" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-lg">
    <div class="px-5 py-4 border-b">
      <h3 class="text-lg font-semibold">Create New Post</h3>
    </div>

    <form id="create-form" class="p-5 space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
        <textarea name="content" rows="4"
          class="w-full border border-gray-300 rounded-lg p-2 text-gray-800 focus:ring-emerald-500 focus:border-emerald-500"
          placeholder="Ceritakan pengalaman Anda" required></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select name="category"
          class="w-full border border-gray-300 rounded-lg p-2 text-gray-800 focus:ring-emerald-500 focus:border-emerald-500">
          <option value="soccer">Soccer</option>
          <option value="futsal">Futsal</option>
          <option value="basket">Basket</option>
          <option value="badminton">Badminton</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
        <input type="url" name="thumbnail"
          class="w-full border border-gray-300 rounded-lg p-2 text-gray-800 focus:ring-emerald-500 focus:border-emerald-500"
          placeholder="https://..." />
      </div>

      <label class="inline-flex items-center gap-2">
        <input type="checkbox" name="is_featured" class="accent-emerald-600">
        <span class="text-sm text-gray-700">Featured</span>
      </label>

      <div class="pt-2 flex justify-end gap-2">
        <button type="button" id="btn-cancel-create" class="px-4 py-2 rounded-lg border">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Publish</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Edit Post -->
<div id="edit-modal" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-lg">
    <div class="px-5 py-4 border-b">
      <h3 class="text-lg font-semibold">Edit Post</h3>
    </div>
    <form id="edit-form" class="p-5 space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
        <textarea name="content" rows="4"
          class="w-full border border-gray-300 rounded-lg p-2 text-gray-800 focus:ring-emerald-500 focus:border-emerald-500"
          required></textarea>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <select name="category" class="w-full border border-gray-300 rounded-lg p-2 text-gray-800 focus:ring-emerald-500 focus:border-emerald-500">
          <option value="soccer">Soccer</option>
          <option value="futsal">Futsal</option>
          <option value="basket">Basket</option>
          <option value="badminton">Badminton</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
        <input type="url" name="thumbnail" class="w-full border border-gray-300 rounded-lg p-2 text-gray-800 focus:ring-emerald-500 focus:border-emerald-500" />
      </div>

      <label class="inline-flex items-center gap-2">
        <input type="checkbox" name="is_featured" class="accent-emerald-600">
        <span class="text-sm text-gray-700">Featured</span>
      </label>

      <div class="pt-2 flex justify-end gap-2">
        <button type="button" id="btn-cancel-edit" class="px-4 py-2 rounded-lg border">Cancel</button>
        <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Delete Post -->
<div id="delete-modal" class="hidden fixed inset-0 bg-black/40 z-50 items-center justify-center">
  <div class="bg-white rounded-xl shadow-xl w-11/12 max-w-md p-6">
    <h3 class="text-lg font-semibold mb-2">Delete Post</h3>
    <p class="text-gray-700 mb-6">Are you sure you want to delete this post?</p>
    <div class="flex justify-end gap-2">
      <button type="button" id="btn-cancel-delete" class="px-4 py-2 rounded-lg border">Cancel</button>
      <button type="button" id="btn-confirm-delete" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Delete</button>
    </div>
  </div>
</div>


<script>
  // ======== CONFIG & STATE ========
  const POSTS_API = "{% url 'feeds:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

  let activeFilter = 'all';          // 'all' | 'my'
  let activeCategory = 'all';        // 'all' | soccer | futsal | basket | badminton | other
  let allPosts = [];

  // ======== DOM ========
  const btnAll = document.getElementById('btn-all');
  const btnMy = document.getElementById('btn-my');
  const selectCategory = document.getElementById('select-category');

  const elLoading = document.getElementById('feeds-loading');
  const elError   = document.getElementById('feeds-error');
  const elEmpty   = document.getElementById('feeds-empty');
  const elList    = document.getElementById('feeds-list');

  // ======== HELPERS ========
  function setBarState() {
    const BASE = "px-5 py-2 rounded-full font-semibold transition shadow-none";
    const ACTIVE   = BASE + " bg-emerald-500 text-white shadow";
    const INACTIVE = BASE + " bg-transparent text-emerald-700 border border-emerald-300 hover:bg-emerald-50";

    if (activeFilter === 'all') { btnAll.className = ACTIVE; btnMy.className = INACTIVE; }
    else                        { btnMy.className  = ACTIVE; btnAll.className = INACTIVE; }
  }



  function showSection({loading=false, error=false, empty=false, list=false}) {
    elLoading.classList.toggle('hidden', !loading);
    elError.classList.toggle('hidden', !error);
    elEmpty.classList.toggle('hidden', !empty);
    elList.classList.toggle('hidden', !list);
  }

  function catLabel(code) {
    const m = {soccer:'Soccer', futsal:'Futsal', basket:'Basket', badminton:'Badminton', other:'Other'};
    return m[code] || code;
  }

  function fmtDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'}) + ' ' +
           d.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
  }

  function buildCard(p) {
    const detailUrl = "{% url 'feeds:show_post' '00000000-0000-0000-0000-000000000000' %}"
                        .replace('00000000-0000-0000-0000-000000000000', p.id);
    const editUrl   = "{% url 'feeds:edit_post' '00000000-0000-0000-0000-000000000000' %}"
                        .replace('00000000-0000-0000-0000-000000000000', p.id);
    const deleteUrl = "{% url 'feeds:delete_post' '00000000-0000-0000-0000-000000000000' %}"
                        .replace('00000000-0000-0000-0000-000000000000', p.id);

    const ownerMenu = (CURRENT_USER_ID && String(CURRENT_USER_ID) === String(p.user_id)) ? `
      <div class="relative z-20 pointer-events-auto">
        <button type="button" class="menu-btn p-2 rounded-full hover:bg-gray-100" data-id="${p.id}" aria-haspopup="true">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
            <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0zm6 0a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
        </button>
        <div class="menu-dd hidden absolute right-0 top-10 w-36 rounded-xl border border-gray-200 bg-white shadow-lg z-30" data-id="${p.id}">
          <button type="button" class="block w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-gray-50 edit-btn" data-id="${p.id}">Edit</button>
          <button type="button" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 delete-btn" data-id="${p.id}">Delete</button>
        </div>
      </div>` : '';

    const imgSrc = p.image_url || p.thumbnail;
    const thumb = imgSrc
      ? `<img class="mt-3 rounded-lg max-h-52 w-full object-cover" src="${imgSrc}" alt="thumbnail">`
      : '';

    const featured = p.is_featured ? ' | <b>Featured</b>' : '';
    const hot = p.is_hot ? ' | <b>Hot</b>' : '';

    return `
      <article class="group relative bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition">
        <!-- stretched link yang menutupi seluruh kartu -->
        <a href="${detailUrl}" aria-label="Open post" class="absolute inset-0 rounded-xl z-10"></a>

        <!-- Konten diset pointer-events-none supaya klik jatuh ke anchor di atas -->
        <div class="p-4 pointer-events-none">
          <div class="flex items-start justify-between">
            <div class="text-base font-semibold text-gray-900">
              ${p.user_username ? '@'+p.user_username : 'Anon'}
            </div>
            ${ownerMenu}
          </div>

          ${thumb}

          <p class="text-sm text-gray-600 mt-2">
            <b>${catLabel(p.category)}</b>${featured}${hot}
            | <i>${fmtDate(p.created_at)}</i>
            | Views: ${p.post_views}
          </p>
          <p class="mt-3 text-gray-800">${p.content}</p>
        </div>
      </article>
    `;
  }

  // Buka/tutup dropdown per-post
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.menu-btn');
    const anyMenu = document.querySelectorAll('.menu-dd');

    if (btn) {
      const id = btn.dataset.id;
      // tutup semua dulu
      anyMenu.forEach(dd => dd.classList.add('hidden'));
      // toggle menu milik card ini
      const dd = document.querySelector(`.menu-dd[data-id="${id}"]`);
      dd?.classList.toggle('hidden');
      return;
    }

    // klik di luar -> tutup semua menu
    if (!e.target.closest('.menu-dd')) {
      anyMenu.forEach(dd => dd.classList.add('hidden'));
    }
  });

  function applyFilters() {
    let rows = [...allPosts];

    // filter my
    if (activeFilter === 'my' && CURRENT_USER_ID) {
      rows = rows.filter(x => String(x.user_id) === String(CURRENT_USER_ID));
    }

    // filter category
    if (activeCategory !== 'all') {
      rows = rows.filter(x => x.category === activeCategory);
    }

    if (rows.length === 0) {
      showSection({empty:true});
      elList.innerHTML = '';
      return;
    }

    elList.innerHTML = rows.map(buildCard).join('');
    showSection({list:true});
  }

  function normalizeURL() {
    const clean = window.location.pathname; 
    if (window.location.search || window.location.hash) {
      history.replaceState(null, '', clean);
    }
  }

  async function loadPosts() {
    try {
      showSection({loading:true});
      const bust = (POSTS_API.includes('?') ? '&' : '?') + 't=' + Date.now();
      const res = await fetch(POSTS_API + bust, {
        headers: {'Accept':'application/json', 'Cache-Control': 'no-cache'},
        cache: 'no-store',
      });

      if (!res.ok) throw new Error('Bad status');
      const data = await res.json();
      allPosts = Array.isArray(data) ? data : [];
      applyFilters();
    } catch (e) {
      console.error(e);
      showSection({error:true});
    }
  }

  // ======== INIT ========
  function restoreState() {
    const saved = sessionStorage.getItem('feeds_state');
    if (saved) {
      try {
        const s = JSON.parse(saved);
        if (s.activeFilter)   activeFilter = s.activeFilter;     // 'all' | 'my'
        if (s.activeCategory) activeCategory = s.activeCategory; // 'all'|'soccer'...
      } catch(_) {}
    }
  }

  function persistState() {
    sessionStorage.setItem('feeds_state', JSON.stringify({
      activeFilter, activeCategory
    }));
  }

  // event handlers: simpan state tiap berubah
  btnAll.addEventListener('click', () => {
    activeFilter = 'all'; setBarState(); applyFilters(); persistState();
  });
  btnMy.addEventListener('click', () => {
    activeFilter = 'my';  setBarState(); applyFilters(); persistState();
  });
  selectCategory.addEventListener('change', (e) => {
    activeCategory = e.target.value; applyFilters(); persistState();
  });

  // urutan init
  normalizeURL();
  restoreState();
  setBarState();
  loadPosts();

  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // ==== Element modal ====
  const createModal     = document.getElementById('create-modal');
  const createForm      = document.getElementById('create-form');
  const btnOpenCreate   = document.getElementById('btn-open-create');
  const btnCancelCreate = document.getElementById('btn-cancel-create');

  function openCreateModal()  { createModal.classList.remove('hidden'); createModal.classList.add('flex'); }
  function closeCreateModal() { createModal.classList.add('hidden');   createModal.classList.remove('flex'); }

  btnOpenCreate.addEventListener('click', openCreateModal);
  // tombol "Buat Post Baru" di empty-state
  const btnEmptyCreate = document.getElementById('btn-empty-create');
  btnEmptyCreate?.addEventListener('click', openCreateModal);

  btnCancelCreate.addEventListener('click', closeCreateModal);
  // overlay untuk tutup
  createModal.addEventListener('click', (e) => { if (e.target === createModal) closeCreateModal(); });

  // ==== Submit Create via AJAX ====
  createForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(createForm);

    try {
      const res = await fetch("{% url 'feeds:create_post_ajax' %}", {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken },
        body: formData
      });
      if (!res.ok) throw new Error(await res.text());
      const out = await res.json();

      // Beres: tutup & reset
      closeCreateModal();
      createForm.reset();

      if (typeof showToast === 'function') showToast('Post created', '', 'success');

      // Refresh list tanpa ganti URL / filter
      loadPosts();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch (err) {
      console.error(err);
      if (typeof showToast === 'function') showToast('Failed to create post', '', 'error');
      else alert('Create failed');
    }
  });

  // === EDIT MODAL ===
  const editModal     = document.getElementById('edit-modal');
  const editForm      = document.getElementById('edit-form');
  const btnCancelEdit = document.getElementById('btn-cancel-edit');
  let editingId = null;

  function openEditModal() { editModal.classList.remove('hidden'); editModal.classList.add('flex'); }
  function closeEditModal() { editModal.classList.add('hidden'); editModal.classList.remove('flex'); }

  btnCancelEdit.addEventListener('click', closeEditModal);
  editModal.addEventListener('click', e => { if (e.target === editModal) closeEditModal(); });

  // Klik edit di menu per-post
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.edit-btn');
    if (btn) {
      editingId = btn.dataset.id;

      // ambil data post detail buat isi modal
      const res = await fetch(`/feeds/api/post/${editingId}/`);
      const post = await res.json();

      editForm.content.value = post.content;
      editForm.category.value = post.category;
      editForm.thumbnail.value = post.thumbnail;
      editForm.is_featured.checked = post.is_featured;

      openEditModal();
    }
  });

  // === DELETE ===
  const deleteModal     = document.getElementById('delete-modal');
  const btnCancelDelete = document.getElementById('btn-cancel-delete');
  const btnConfirmDelete= document.getElementById('btn-confirm-delete');
  let deletingId = null;

  function openDeleteModal(){ deleteModal.classList.remove('hidden'); deleteModal.classList.add('flex'); }
  function closeDeleteModal(){ deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex'); }

  btnCancelDelete.addEventListener('click', closeDeleteModal);
  deleteModal.addEventListener('click', e => { if (e.target === deleteModal) closeDeleteModal(); });

  //Delete di dropdown card
  document.addEventListener('click', (e) => {
    const delBtn = e.target.closest('.delete-btn');
    if (!delBtn) return;

    deletingId = delBtn.dataset.id;

    // tutup semua dropdown dulu
    document.querySelectorAll('.menu-dd').forEach(dd => dd.classList.add('hidden'));

    openDeleteModal();
  });

  // konfirmasi hapus
  btnConfirmDelete.addEventListener('click', async () => {
    if (!deletingId) return;

    try {
      const res = await fetch(`/feeds/api/post/${deletingId}/delete`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken }
      });

      if (!res.ok) {
        const msg = await res.text();
        throw new Error(msg || 'Failed');
      }

      const out = await res.json();
      closeDeleteModal();

      // refresh list biar hilang dari feed
      await loadPosts();

      if (typeof showToast === 'function') {
        showToast('Post deleted', '', 'success');
      }
    } catch (err) {
      console.error(err);
      if (typeof showToast === 'function') {
        showToast('Failed to delete', '', 'error');
      } else {
        alert('Delete failed');
      }
    } finally {
      deletingId = null;
    }
  });


  // Submit edit via AJAX
  editForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(editForm);

    const res = await fetch(`/feeds/api/post/${editingId}/edit`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: formData
    });

    if (res.ok) {
      closeEditModal();
      editForm.reset();
      loadPosts();
      if (typeof showToast === 'function') {
        showToast('Post updated successfully', '', 'success');
      }
    } else {
      if (typeof showToast === 'function') {
        showToast('Failed to update post ❌', '', 'error');
      } else {
        alert('Failed to update post');
      }
    }
  });


  document.addEventListener('postAdded', () => loadPosts());
</script>

{% endblock content %}
