{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Dashboard - LapaNG</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<style>
/* Hide scrollbar for bookings panel but keep it scrollable */
/* WebKit browsers (Chrome, Safari) */
#bookings-panel::-webkit-scrollbar {
  width: 0px;
  height: 0px;
  display: none;
}

/* Firefox */
#bookings-panel {
  -ms-overflow-style: none; /* IE 10+ */
  scrollbar-width: none; /* Firefox */
}

/* Optional: small visual improvement â€” add subtle inner padding so last item isn't flush */
#bookings-panel .space-y-4:last-child {
  padding-bottom: 8px;
}
</style>

<div class="min-h-1/2 bg-gray-50 pt-24 px-6 pb-6">
  <div class="max-w-7xl mx-auto" style="height: calc(50vh - 4rem);">
    <div class="flex flex-col lg:flex-row lg:items-start gap-6 h-full">

      <!-- LEFT CARD -->
      <aside class="w-full lg:w-3/12 flex-none">
        <div class="lg:sticky lg:top-24">
          <div class="w-full flex items-stretch">
            <!-- Card: flex column so content stacks and can grow naturally -->
            <div class="bg-gradient-to-br from-[#3b82f680] to-[#10b98180] rounded-2xl shadow-lg p-6 text-center w-full flex flex-col items-center justify-start">
                
                {% if profile and profile.profile_picture %}
                <img src="{{ profile.profile_picture }}" alt="{{ user.username }}"
                    class="w-36 h-36 rounded-full object-cover border-2 border-white shadow-sm mb-4 profile-avatar" />
                {% else %}
                <img src="{% static 'images/user.png' %}" alt="avatar"
                    class="w-36 h-36 rounded-full object-cover border-2 border-white shadow-sm mb-4 profile-avatar" />
                {% endif %}

                <h2 class="text-2xl font-extrabold text-gray-900 profile-fullname">
                {{ user.customuser.name }}
                </h2>

                {% if profile.number %}
                <p id="profile-number" class="text-gray-500 text-sm mt-1" data-raw="{{ profile.number }}">
                    {{ profile.formatted_number }}
                </p>
                {% endif %}

                <p class="text-sm text-green-600 mt-1 profile-role">{{ profile.role|capfirst }}</p>

                <!-- Stats grid -->
                <div class="mt-6 grid grid-cols-3 gap-3 text-center w-full max-w-xs">
                <div>
                    <div class="text-xs text-gray-500">Bookings</div>
                    <div class="font-semibold text-gray-800">{{ counts.bookings|default:0 }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Equipment</div>
                    <div class="font-semibold text-gray-800">{{ counts.equipment|default:0 }}</div>
                </div>
                <div>
                    <div class="text-xs text-gray-500">Reviews</div>
                    <div class="font-semibold text-gray-800">{{ counts.reviews|default:0 }}</div>
                </div>
                </div>

                <div class="mt-auto w-full flex justify-center gap-3 pt-6 pb-2">
                <!-- EDIT BUTTON -->
                <button id="edit-profile-btn"
                        data-username="{{ user.username|default:'' }}"
                        data-name="{{ profile.name|default:user.get_full_name|default:'' }}"
                        data-number="{{ profile.number|default:'' }}"
                        data-profile_picture="{{ profile.profile_picture|default:'' }}"
                        data-edit-url="{% url 'authentication:edit_profile' %}"
                        class="flex items-center gap-2 px-4 py-2 rounded text-sm border border-white/60 bg-white/20 backdrop-blur-sm text-gray-800 shadow-sm hover:bg-white/25 hover:shadow-md transition">
                    <svg class="w-4 h-4 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536M9 11l6-6 3 3-6 6H9v-3z" />
                    </svg>
                    <span>Edit</span>
                </button>

                <!-- DELETE BUTTON -->
                <button id="delete-profile-btn"
                        data-delete-url="{% url 'authentication:delete_profile' %}"
                        class="flex items-center gap-2 px-4 py-2 rounded text-sm border border-red-500 bg-red-500/20 backdrop-blur-sm text-red-600 shadow-sm hover:bg-red-500/40 hover:shadow-md transition">
                    <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    <span>Delete</span>
                </button>
                </div>

            </div>
          </div>
        </div>
      </aside>


      <!-- RIGHT CARD -->
      <main class="w-full lg:flex-1 h-full">
        <div class="bg-gradient-to-br from-[#3b82f680] to-[#10b98180] rounded-2xl shadow-lg overflow-hidden h-full flex flex-col">
          <!-- header (fixed) -->
          <div class="px-6 py-5">
            <h2 class="text-2xl font-extrabold text-green-600">Booked Courts</h3>
          </div>

          <!-- bookings content area: independent scrollable panel -->
          <div class="p-6 flex-1 overflow-hidden">
            <div id="bookings-panel"
                 data-limit="{{ bookings_limit|default:12 }}"
                 data-default-image="{% static 'images/No_Image_Available.jpg' %}"
                 data-calendar-icon="{% static 'images/calendar.png' %}"
                 data-clock-icon="{% static 'images/clock.png' %}"
                 data-edit-url-template="{% url 'booking:edit_booking' 999999 %}"
                 data-clear-url-template="{% url 'booking:clear_booking' 999999 %}"
                 data-id-placeholder="999999"
                 class="h-full overflow-auto pr-2 space-y-4"
                 style="height: 100%;">
              <!-- booking cards will be appended here by dashboard.js -->
              <div id="bookings-list" class="space-y-4"></div>

              <div id="bookings-loading" class="text-center py-4 hidden">
                <svg class="animate-spin h-6 w-6 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
              </div>
              <div id="bookings-end" class="text-center text-gray-500 hidden"></div>
            </div>
          </div>
        </div>
      </main>

    </div>
  </div>
</div>

<!-- Toast container -->
<div id="global-toast" class="fixed bottom-6 right-6 z-60 hidden">
  <div id="global-toast-inner"
       class="max-w-sm w-full rounded-lg shadow-lg p-3 flex items-center gap-3 bg-green-600 text-white transform transition-all duration-500 opacity-0 translate-y-4">
    <svg class="w-5 h-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414L9 14.414 5.293 10.707a1 1 0 011.414-1.414L9 11.586l6.293-6.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
    </svg>
    <div id="global-toast-message" class="text-sm font-medium">Profile Updated!</div>
  </div>
</div>

<style>
  /* Smooth slide-up + fade animation for toast */
  @keyframes toastSlideIn {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes toastSlideOut {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(16px); }
  }
  .toast-show { animation: toastSlideIn 0.4s ease-out forwards; }
  .toast-hide { animation: toastSlideOut 0.4s ease-in forwards; }
</style>

<!--Show Toast Script-->
<script>
function showToast(message = 'Saved', {duration = 2500} = {}) {
  const toastWrap = document.getElementById('global-toast');
  const toastInner = document.getElementById('global-toast-inner');
  const toastMsg = document.getElementById('global-toast-message');
  if (!toastWrap || !toastInner || !toastMsg) return;

  toastMsg.textContent = message;
  toastWrap.classList.remove('hidden');
  toastInner.classList.remove('toast-hide');
  toastInner.classList.add('toast-show');

  clearTimeout(toastWrap._hideTimeout);
  toastWrap._hideTimeout = setTimeout(() => {
    toastInner.classList.remove('toast-show');
    toastInner.classList.add('toast-hide');
    setTimeout(() => { toastWrap.classList.add('hidden'); }, 400);
  }, duration);
}
</script>

<!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
  <div class="absolute inset-0 bg-black/40"></div>

  <div class="relative w-full max-w-lg mx-auto">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="px-6 py-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-800">Edit profile</h3>
        <button id="edit-profile-close" class="text-2xl leading-none text-gray-500 hover:text-gray-700">&times;</button>
      </div>

      <div class="px-6 py-5">
        <div id="edit-profile-alert" class="hidden mb-4 p-3 rounded text-sm"></div>

        <form id="edit-profile-form" method="post" novalidate>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
              <input name="username" id="ep-username" class="w-full px-4 py-2 border rounded" />
              <p class="text-red-600 text-sm mt-1 hidden ep-err" data-field="username"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Full name</label>
              <input name="name" id="ep-name" class="w-full px-4 py-2 border rounded" />
              <p class="text-red-600 text-sm mt-1 hidden ep-err" data-field="name"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone number</label>
              <input name="number" id="ep-number" class="w-full px-4 py-2 border rounded" inputmode="numeric" />
              <p class="text-xs text-gray-500 mt-1">Enter digits only, no leading 0 or +62</p>
              <p class="text-red-600 text-sm mt-1 hidden ep-err" data-field="number"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Profile picture (URL)</label>
              <input name="profile_picture" id="ep-profile_picture" class="w-full px-4 py-2 border rounded" />
              <p class="text-red-600 text-sm mt-1 hidden ep-err" data-field="profile_picture"></p>
            </div>

            <div class="pt-3">
              <button id="ep-submit" type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded">Save changes</button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- Delete Profile Modal -->
<div id="delete-confirm-modal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
  <div class="absolute inset-0 bg-black/50"></div>

  <div class="relative w-full max-w-md mx-auto">
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
      <div class="px-6 py-6 text-center">
        <h3 class="text-xl font-bold text-gray-800 mb-2">Are you sure?</h3>
        <p class="text-sm text-gray-500 mb-6">This will permanently delete your profile and you will be logged out.</p>

        <div class="flex items-center justify-center gap-4">
          <button id="confirm-delete-yes"
                  class="px-5 py-2 border border-green-600 text-green-600 bg-white rounded hover:bg-green-50">
            Yes
          </button>

          <button id="confirm-delete-no"
                  class="px-5 py-2 bg-red-600 text-white rounded hover:opacity-90">
            No
          </button>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock scripts %}