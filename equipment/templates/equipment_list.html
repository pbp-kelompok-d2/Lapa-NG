{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'navbar.html' %}

<div class="px-8 py-6">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">Daftar Equipment</h1>

    {% if user.is_authenticated %}
      <a href="{% url 'equipment:add_equipment' %}" 
         class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md transition">
        + Add Equipment
      </a>
    {% endif %}
  </div>

  <!-- Search & Filter Section -->
  <div class="bg-white rounded-xl shadow p-4 mb-8">
    <div class="flex flex-wrap items-center gap-4">
      <!-- Search Bar -->
      <div class="flex items-center border rounded-lg px-3 py-2 w-full md:w-1/3">
        <input type="text" id="searchInput" placeholder="Search equipment..." 
               class="flex-grow focus:outline-none" />
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/>
        </svg>
      </div>

      <!-- Sport Category Filter -->
      <select id="sportFilter" class="border rounded-lg px-3 py-2">
        <option value="all">All Sports</option>
        {% for value, label in sports %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>

      <!-- Region Filter -->
      <select id="regionFilter" class="border rounded-lg px-3 py-2">
        <option value="all">All Regions</option>
        {% for value, label in regions %}
          <option value="{{ value }}">{{ label }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- Equipment Grid -->
  <div id="equipmentGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    {% for eq in equipments %}
      <div class="bg-white rounded-2xl shadow-md hover:shadow-lg transition p-4">
        <img src="{{ eq.thumbnail }}" alt="{{ eq.name }}" class="w-full h-40 object-cover rounded-xl mb-3">
        <h2 class="font-semibold text-lg text-gray-800">{{ eq.name }}</h2>
        <p class="text-sm text-gray-500">Kategori: {{ eq.get_sport_category_display }}</p>
        <p class="text-sm text-gray-500">Wilayah: {{ eq.get_region_display }}</p>
        <p class="text-sm text-gray-700 font-medium mt-2">ðŸ’° Rp {{ eq.price_per_hour }}</p>
        <p class="text-sm text-gray-700">ðŸ“¦ Quantity: {{ eq.quantity }}</p>
        {% if eq.available %}
          <p class="text-green-600 text-sm font-semibold mt-1">Tersedia</p>
        {% else %}
          <p class="text-red-500 text-sm font-semibold mt-1">Tidak tersedia</p>
        {% endif %}
        {% if user == eq.owner %}
          <div class="flex justify-between mt-3">
            <a href="{% url 'equipment:edit_equipment' eq.id %}" 
               class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition text-sm">
              Edit
            </a>
            <a href="{% url 'equipment:delete_equipment' eq.id %}" 
               class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-sm">
              Delete
            </a>
          </div>
        {% endif %}
      </div>
    {% empty %}
      <p class="text-gray-500">No equipment available.</p>
    {% endfor %}
  </div>
</div>

<!-- AJAX Filtering -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function(){
    function fetchEquipments(){
      const sport = $('#sportFilter').val();
      const region = $('#regionFilter').val();
      const search = $('#searchInput').val();

      $.ajax({
        url: "{% url 'equipment:equipment_list' %}",
        data: { sport_category: sport, region: region, search: search },
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        success: function(response){
          const equipments = response.equipments;
          let html = '';
          if(equipments.length === 0){
            html = '<p class="text-gray-500">Tidak ada equipment ditemukan.</p>';
          } else {
            equipments.forEach(eq => {
              html += `
                <div class="bg-white rounded-2xl shadow-md hover:shadow-lg transition p-4">
                  <img src="${eq.thumbnail}" alt="${eq.name}" class="w-full h-40 object-cover rounded-xl mb-3">
                  <h2 class="font-semibold text-lg text-gray-800">${eq.name}</h2>
                  <p class="text-sm text-gray-500">Kategori: ${eq.sport_category}</p>
                  <p class="text-sm text-gray-500">Wilayah: ${eq.region}</p>
                  <p class="text-sm text-gray-700 font-medium mt-2">ðŸ’° Rp ${eq.price_per_hour}</p>
                  <p class="text-sm text-gray-700">ðŸ“¦ Quantity: ${eq.quantity}</p>
                  ${eq.available ? 
                    '<p class="text-green-600 text-sm font-semibold mt-1">Tersedia</p>' :
                    '<p class="text-red-500 text-sm font-semibold mt-1">Tidak tersedia</p>'
                  }
                </div>`;
            });
          }
          $('#equipmentGrid').html(html);
        }
      });
    }

    $('#sportFilter, #regionFilter, #searchInput').on('input change', fetchEquipments);
  });
</script>

{% endblock %}
